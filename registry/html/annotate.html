<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Annotate: /read/@URL_PATH@</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"> </script>
    <script src="/annotator-full.min.js"> </script>
    <link rel="stylesheet" href="/annotator.min.css">

    <script type="application/javascript">

jQuery(document).ready(function () {
    var urlPath = "/read/@URL_PATH@";

    jQuery.get(urlPath, function (data) {

        /*-
         * XXX Remove many tags (head, script, iframe, noscript) to make
         * sure that we only load the bare minimum of the post.
         *
         * We cannot load JavaScript because it may conflict with the jQuery
         * that we use; we cannot load the CSSs because they may be over http,
         * and so they won't load anyway.
         *
         * To this end, use the following StackOverflow recipe:
         *
         *     http://stackoverflow.com/questions/6659351
         */

        data = data.replace(
            /<head\b[^<]*(?:(?!<\/head>)<[^<]*)*<\/head>/gi,
            "<head><title>/read/@URL_PATH@</title></head>");

        data = data.replace(
            /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, "");

        data = data.replace(
            /<noscript\b[^<]*(?:(?!<\/noscript>)<[^<]*)*<\/noscript>/gi, "");

        jQuery("#content").html(data);

        //
        // Deal with images surrounded by a link first, because they
        // require a more complicated processing.
        //
        jQuery("a img").each(function () {
            var origLink = this.parentNode;
            var container = origLink.parentNode;
            var externalSpan = document.createElement("span");
            var imgAsLink = document.createElement("a");
            imgAsLink.href = this.src;
            imgAsLink.text = "[ImgSrc]";
            externalSpan.appendChild(imgAsLink);
            var newLink = document.createElement("a");
            newLink.href = origLink.href;
            newLink.text = "[ImgOnClick]";
            externalSpan.appendChild(newLink);
            container.replaceChild(externalSpan, origLink);
        });

        // Replace image with link pointing to its source
        jQuery('img').each(function () {
            var link = "<a href='" + this.src + "'>[ImgSrc]</a>";
            $(this).replaceWith(link);
        });

        var content = jQuery("#content").annotator();
        content.annotator("addPlugin", "Store", {
            "prefix": "/annotator",
            annotationData: {
                "uri": urlPath
            },
            loadFromSearch: {
                "limit": 0,
                "uri": urlPath
            }
	});

    });
});

    </script>
  </head>
  <body>
    <p>
      <span><a href="http://127.0.0.1:8080/read/@URL_PATH@"
        target="_blank">[originale]</a></span>
      <span><a href="http://127.0.0.1:8080/view-source/@URL_PATH@"
        target="_blank">[sorgente]</a></span>
    </p>
    <hr />
    <div id="content"></div>
  </body>
</html>
